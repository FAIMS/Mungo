/****** 
 FAIMS Logic File generated by Heurist Vsn 3.1.6, Wednesday 12th of March 2014 03:34:42 AM
 Database: hdb_nstern_FeatureRecording   Heurist user:Adela Sobotkova
 ******/

User user;
String userid;

setSyncEnabled(true);
setFileSyncEnabled(true);

/*** EVENTS ***/
onEvent("control", "show", "refreshGrids()");
onEvent("control", "load", "loadHearthAttributes()");
onEvent("control", "load", "loadHearthAssociatedAttributes()");

onEvent("control/grid/addGrid", "click", "newGrid()");
onEvent("control/grid/GridList", "click", "loadGrid()");

/** RelnEnt: Grid Square **/
onEvent("Grid/Grid", "show", "refreshFeatures()");
onEvent("Grid/Grid/Update", "delayclick", "saveGrid()");
onEvent("Grid/Grid/addHearth", "click", "newHearth()");
onEvent("Grid/Features/FeatureList", "click", "loadHearth()");

String grid_id = null;

newGrid(){
    grid_id = null;
    newTabGroup("Grid");
}
loadGrid() {
    grid_id = getListItemValue();
    loadGridFrom(grid_id);
}
loadGridFrom(entid) {
    grid_id = entid;
    if (isNull(entid)) return;
    showTabGroup("Grid", entid);    
}

saveGrid() {
    if (isNull(getFieldValue("Grid/Grid/Name"))) { 
        showWarning("Validation Error", "Cannot save Grid Square without identifier.");
        showTabGroup("Grid");
        return;
    }
    if (!isNull(grid_id)) {
        entity = fetchRel(grid_id);
    }
    saveTabGroup("Grid", grid_id, null, null, "grid_id = getLastSavedRecordId();");
}

refreshGrids() {
    populateList("control/grid/GridList", fetchRelationshipList("Grid"));
}

refreshFeatures(){
    if (!isNull(grid_id)){
        featuresInGrid = fetchAll("select uuid, freetext " +
        "from latestNonDeletedArchEntIdentifiers " +
        "where uuid in (select uuid " +
                "from latestnondeletedaentreln " +
                "where relationshipid = '" + grid_id+ "');");
        populateList("Grid/Features/FeatureList", featuresInGrid);
    } else {
        Object empty = fetchAll("select '', '';");
        populateList("Grid/Features/FeatureList",  empty);
    }
}

/** ArchEnt: HEARTH **/
onEvent("Hearth/Admin/Update", "delayclick", "saveHearth()");
onEvent("Hearth/Admin/Delete", "delayclick", "deleteHearth()");

onEvent("Hearth/Associated_materials/addAssociated", "delayclick", "newHearthAssociated()");
onEvent("Hearth/Associated_materials/AssociatedList", "click", "loadHearthAssociated()");
onEvent("Hearth", "show", "refreshHearthAssociated()");

onEvent("Hearth/Topography/attachPhoto", "click", "attachPictureTo(\"Hearth/Topography/Photos\")");
onEvent("Hearth/Topography/Update", "delayclick", "saveHearth()");
onEvent("Hearth/Topography/Delete", "delayclick", "deleteHearth()");

String hearth_id = null;

newHearth(){
    hearth_id = null;
    newTabGroup("Hearth");
    saveGrid();
}
loadHearth() {
    hearth_id = getListItemValue();
    loadHearthFrom(hearth_id);
}
loadHearthFrom(entid) {
    hearth_id = entid;
    if (isNull(entid)) return;
    showTabGroup("Hearth", entid);    
}

saveHearth() {
    if (isNull(getFieldValue("Hearth/Admin/ID"))) { 
        showWarning("Validation Error", "Cannot save Hearth without identifier.");
        showTabGroup("Hearth");
        return;
    }
    if (!isNull(hearth_id)) {
        entity = fetchArchEnt(hearth_id);
    }
    saveTabGroup("Hearth", hearth_id, null, null, "hearth_id = getLastSavedRecordId();addReln(hearth_id, grid_id, \"Grid\");");
}

deleteHearth(){
    if (!isNull(hearth_id)) {
        showAlert("Confirm Deletion", "Press OK to Delete this Hearth!", "reallyDeleteHearth()", "doNotDelete()");
    } else {
        cancelTabGroup("Hearth", false);
    }
}

reallyDeleteHearth(){
    deleteArchEnt(hearth_id);
    cancelTabGroup("Hearth", false);
}

refreshHearthAssociated() {
    if (!isNull(hearth_id)){
        associatedHearth = fetchAll("select relationshipid, group_concat(VocabName)" +
            "from (select relationshipid, vocabname, freetext " +
                "from latestnondeletedrelnidentifiers " +
                "where relntypename = 'HearthAssociated'" + 
                "and relationshipid in (select relationshipid " +
                                        "from latestnondeletedaentreln " +
                                        "where uuid = " + hearth_id + ")" +
               ")" +
        "group by relationshipid;");
        populateList("Hearth/Associated_materials/AssociatedList", associatedHearth);
    } else {
        Object empty = fetchAll("select '', '';");
        populateList("Hearth/Associated_materials/AssociatedList",  empty);
    }
}

loadHearthAttributes() {
    populateHierarchicalPictureGallery("Hearth/Admin/HearthType", "Hearth Type");
    populatePictureGallery("Hearth/Admin/Charcoal", makePictureGallery("Charcoal"));
    populatePictureGallery("Hearth/Admin/DegreeInSitu", makePictureGallery("Degree in situ"));
    populateCheckBoxGroup("Hearth/Admin/ModificationOfHeatRetainerHearths", makeVocab("Modification of heat retainer hearths?"));
    populateCheckBoxGroup("Hearth/Admin/ModificationOfNonHeatRetainerHearths", makeVocab("Modification of non heat retainer hearths?"));
    populateDropDown("Hearth/Topography/TopoSetting", makeVocab("Topo setting"));
    populatePictureGallery("Hearth/Topography/Sediments", makePictureGallery("Sediments"));
    populateDropDown("Hearth/Topography/Vulnerability", makeVocab("Vulnerability"));
    populatePictureGallery("Hearth/Topography/PalaeotopSetting", makePictureGallery("Palaeotop setting"));
    populateDropDown("Hearth/Topography/TypesOfPhotographsTaken", makeVocab("Types of Photographs taken"));

}

/** RelnEnt: Associated Hearths **/
onEvent("HearthAssociated", "show", "updateTabs()");

onEvent("HearthAssociated/AssociatedMaterial/Update", "delayclick", "saveHearthAssociated()");
onEvent("HearthAssociated/Lacustrine/Update", "delayclick", "saveHearthAssociated()");
onEvent("HearthAssociated/Eggshell/Update", "delayclick", "saveHearthAssociated()");
onEvent("HearthAssociated/TerrestrialBone/Update", "delayclick", "saveHearthAssociated()");
onEvent("HearthAssociated/OtherWork/Update", "delayclick", "saveHearthAssociated()");
onEvent("HearthAssociated/Artefact/Update", "delayclick", "saveHearthAssociated()");
onEvent("HearthAssociated/ChippedStone/Update", "delayclick", "saveHearthAssociated()");
onEvent("HearthAssociated/RetouchedStone/Update", "delayclick", "saveHearthAssociated()");
onEvent("HearthAssociated/GroundMaterial/Update", "delayclick", "saveHearthAssociated()");
onEvent("HearthAssociated/UnmodifiedStone/Update", "delayclick", "saveHearthAssociated()");

onEvent("HearthAssociated/AssociatedMaterial/UpdateAndClose", "delayclick", "saveAndCloseHearthAssociated()");
onEvent("HearthAssociated/Lacustrine/UpdateAndClose", "delayclick", "saveAndCloseHearthAssociated()");
onEvent("HearthAssociated/Eggshell/UpdateAndClose", "delayclick", "saveAndCloseHearthAssociated()");
onEvent("HearthAssociated/TerrestrialBone/UpdateAndClose", "delayclick", "saveAndCloseHearthAssociated()");
onEvent("HearthAssociated/OtherWork/UpdateAndClose", "delayclick", "saveAndCloseHearthAssociated()");
onEvent("HearthAssociated/Artefact/UpdateAndClose", "delayclick", "saveAndCloseHearthAssociated()");
onEvent("HearthAssociated/ChippedStone/UpdateAndClose", "delayclick", "saveAndCloseHearthAssociated()");
onEvent("HearthAssociated/RetouchedStone/UpdateAndClose", "delayclick", "saveAndCloseHearthAssociated()");
onEvent("HearthAssociated/GroundMaterial/UpdateAndClose", "delayclick", "saveAndCloseHearthAssociated()");
onEvent("HearthAssociated/UnmodifiedStone/UpdateAndClose", "delayclick", "saveAndCloseHearthAssociated()");

onEvent("HearthAssociated/AssociatedMaterial/Delete", "delayclick", "deleteHearthAssociated()");
onEvent("HearthAssociated/Lacustrine/Delete", "delayclick", "deleteHearthAssociated()");
onEvent("HearthAssociated/Eggshell/Delete", "delayclick", "deleteHearthAssociated()");
onEvent("HearthAssociated/TerrestrialBone/Delete", "delayclick", "deleteHearthAssociated()");
onEvent("HearthAssociated/OtherWork/Delete", "delayclick", "deleteHearthAssociated()");
onEvent("HearthAssociated/Artefact/Delete", "delayclick", "deleteHearthAssociated()");
onEvent("HearthAssociated/ChippedStone/Delete", "delayclick", "deleteHearthAssociated()");
onEvent("HearthAssociated/RetouchedStone/Delete", "delayclick", "deleteHearthAssociated()");
onEvent("HearthAssociated/GroundMaterial/Delete", "delayclick", "deleteHearthAssociated()");
onEvent("HearthAssociated/UnmodifiedStone/Delete", "delayclick", "deleteHearthAssociated()");

onEvent("HearthAssociated/AssociatedMaterial/ShowTabs", "click", "showHearthMaterialType(true);");
onEvent("HearthAssociated/Artefact/ShowTabs", "click", "showHearthArtefactType(true);");
onEvent("HearthAssociated/ChippedStone/ShowTabs", "click", "showHearthChippedStoneType(true);");


String hearth_associated_id = null;

newHearthAssociated(){
    hearth_associated_id = null;
    newTabGroup("HearthAssociated");
    saveHearth();
}
loadHearthAssociated() {
    hearth_associated_id = getListItemValue();
    loadHearthAssociatedFrom(hearth_associated_id);
}
loadHearthAssociatedFrom(entid) {
    hearth_associated_id = entid;
    if (isNull(entid)) return;
    showTabGroup("HearthAssociated", entid);
}

saveHearthAssociated() {
    if (isNull(getFieldValue("HearthAssociated/AssociatedMaterial/AssociatedMaterial"))) { 
        showWarning("Validation Error", "Cannot save Associated Hearth Material without type.");
        showTabGroup("HearthAssociated");
        return;
    }
    if (!isNull(hearth_associated_id)) {
        entity = fetchRel(hearth_associated_id);
    }
    saveTabGroup("HearthAssociated", hearth_associated_id, null, null, "hearth_associated_id = getLastSavedRecordId();addReln(hearth_id, hearth_associated_id, \"HearthAssociated\");showHearthArtefactType(false);showHearthMaterialType(false);showHearthChippedStoneType(false);");
}

saveAndCloseHearthAssociated(){
    if (isNull(getFieldValue("HearthAssociated/AssociatedMaterial/AssociatedMaterial")) && !(getFieldValue("HearthAssociated/AssociatedMaterial/AssociatedMaterial").equals("None"))) { 
        showWarning("Validation Error", "Cannot save Associated Hearth Material without type.");
        showTabGroup("HearthAssociated");
        return;
    }
    if (!isNull(hearth_associated_id)) {
        entity = fetchArchEnt(hearth_associated_id);
    }
    saveTabGroup("HearthAssociated", hearth_associated_id, null, null, "hearth_associated_id = getLastSavedRecordId();addReln(hearth_id, hearth_associated_id, \"HearthAssociated\");cancelTabGroup(\"HearthAssociated\", false);");
}

deleteHearthAssociated(){
    if (!isNull(hearth_associated_id)) {
        showAlert("Confirm Deletion", "Press OK to Delete this Associated Hearth Material!", "reallyDeleteHearthAssociated()", "doNotDelete()");
    } else {
        cancelTabGroup("HearthAssociated", false);
    }
}

reallyDeleteHearthAssociated(){
    deleteArchEnt(hearth_id);
    cancelTabGroup("HearthAssociated", false);
}

loadHearthAssociatedAttributes(){
    populateCheckBoxGroup("HearthAssociated/AssociatedMaterial/AssociatedMaterial", makeVocab("Associated material"));
    populateCheckBoxGroup("HearthAssociated/Lacustrine/LacustrineMaterial", makeVocab("Lacustrine Material"));
    populateRadioGroup("HearthAssociated/Lacustrine/BurntLacustrineMaterial", makeVocab("Burnt lacustrine material"));
    populateCheckBoxGroup("HearthAssociated/Eggshell/AssociatedEggshell", makeVocab("Associated eggshell"));
    populateRadioGroup("HearthAssociated/Eggshell/BurntEggshell", makeVocab("Burnt eggshell"));
    populatePictureGallery("HearthAssociated/TerrestrialBone/AssociatedTerrestrialBone", makePictureGallery("Associated terrestrial bone"));
    populateRadioGroup("HearthAssociated/TerrestrialBone/BurntBone", makeVocab("Burnt bone"));
    populatePictureGallery("HearthAssociated/OtherWork/OtherWorkedMaterial", makePictureGallery("Other worked material"));
    populateCheckBoxGroup("HearthAssociated/Artefact/AssociatedArtefacts", makeVocab("Associated artefacts"));
    populateCheckBoxGroup("HearthAssociated/Artefact/ArtefactRawMaterial", makeVocab("Artefact raw material"));
    populateCheckBoxGroup("HearthAssociated/ChippedStone/CSTypes", makeVocab("CS types"));
    populateCheckBoxGroup("HearthAssociated/RetouchedStone/RUTypes", makeVocab("RU types"));
    populatePictureGallery("HearthAssociated/GroundMaterial/GroundMaterial", makePictureGallery("Ground material"));
    populateRadioGroup("HearthAssociated/GroundMaterial/GroundMaterialStatus", makeVocab("Ground material status"));
    populateCheckBoxGroup("HearthAssociated/UnmodifiedStone/UnmodTypes", makeVocab("Unmod types"));
}

showHearthMaterialType(trigger) {
    List list = getFieldValue("HearthAssociated/AssociatedMaterial/AssociatedMaterial");
    List fields = new ArrayList();
    for(i = 0; i < list.size(); i++) {
        Object name = fetchOne("select vocabName from vocabulary where vocabid = '"+list.get(i)+"';");
        fields.add(name.get(0));
    }
    show = false;
    if(fields.contains("Artefact")) {
        showTab("HearthAssociated/Artefact");
        show = true;
    }
    if(fields.contains("Other")) {
        showTab("HearthAssociated/OtherWork");
        show = true;
    }
    if(fields.contains("Terrestrial Bone")) {
        showTab("HearthAssociated/TerrestrialBone");
        show = true;
    }
    if(fields.contains("Egg shell")) {
        showTab("HearthAssociated/Eggshell");
        show = true;
    }
    if(fields.contains("Lacustrine")) {
        showTab("HearthAssociated/Lacustrine");
        show = true;
    }
    if(!show && trigger) {
        showToast("Please choose an associated material type");
    }
}

showHearthArtefactType(trigger) {
    List list = getFieldValue("HearthAssociated/Artefact/AssociatedArtefacts");
    List fields = new ArrayList();
    for(i = 0; i < list.size(); i++) {
        Object name = fetchOne("select vocabName from vocabulary where vocabid = '"+list.get(i)+"';");
        fields.add(name.get(0));
    }
    show = false;
    if(fields.contains("{ground_}")) {
        showTab("HearthAssociated/GroundMaterial");
        show = true;
    }
    if(fields.contains("{um_}")) {
        showTab("HearthAssociated/UnmodifiedStone");
        show = true;
    }
    if(fields.contains("{cs_}")) {
        showTab("HearthAssociated/ChippedStone");
        show = true;
    }
    if(!show && trigger) {
        showToast("Please choose a chipped stone type");
    }
}

showHearthChippedStoneType(trigger) {
    List list = getFieldValue("HearthAssociated/ChippedStone/CSTypes");
    List fields = new ArrayList();
    for(i = 0; i < list.size(); i++) {
        Object name = fetchOne("select vocabName from vocabulary where vocabid = '"+list.get(i)+"';");
        fields.add(name.get(0));
    }
    show = false;
    if(fields.contains("{ru_}")) {
        showTab("HearthAssociated/RetouchedStone");
        show = true;
    }
    if(!show && trigger) {
        showToast("No extra details required");
    }
}

updateTabs() {
    showTab("HearthAssociated/Lacustrine");
    showTab("HearthAssociated/Eggshell");
    showTab("HearthAssociated/TerrestrialBone");
    showTab("HearthAssociated/OtherWork");
    showTab("HearthAssociated/Artefact");
    showTab("HearthAssociated/ChippedStone");
    showTab("HearthAssociated/RetouchedStone");
    showTab("HearthAssociated/GroundMaterial");
    showTab("HearthAssociated/UnmodifiedStone");
    cancelTab("HearthAssociated/Lacustrine", false);
    cancelTab("HearthAssociated/Eggshell", false);
    cancelTab("HearthAssociated/TerrestrialBone", false);
    cancelTab("HearthAssociated/OtherWork", false);
    cancelTab("HearthAssociated/Artefact", false);
    cancelTab("HearthAssociated/ChippedStone", false);
    cancelTab("HearthAssociated/RetouchedStone", false);
    cancelTab("HearthAssociated/GroundMaterial", false);
    cancelTab("HearthAssociated/UnmodifiedStone", false);
    showHearthArtefactType(false);
    showHearthMaterialType(false);
    showHearthChippedStoneType(false);
    showTab("HearthAssociated/AssociatedMaterial");
}

// MISC FUNCTIONS    

saveEntitiesToRel(type, entity1, entity2) {
    if (isNull(entity1) || isNull(entity2)) return;
    rel_id = saveRel(null, type, null, null);
    addReln(entity1, rel_id, null);
    addReln(entity2, rel_id, null);
}

makeVocab(String attrib){
    Object a = fetchAll("select vocabid, vocabname from vocabulary join attributekey using (attributeid) where attributename = '"+attrib+"' ");
    return a;
}

makePictureGallery(String attrib){
    fetchAll("select vocabid, vocabname, pictureurl from vocabulary left join attributekey using (attributeid) where attributename = '" + attrib + "';");
}

/*** Uneditable - you can edit the code below with extreme precaution ***/
/*** USER ***/

getDefaultUsersList() {
    users = fetchAll("select userid, fname || ' ' || lname from user");
    return users;
}

populateListForUsers(){
    populateList("user/usertab/users", getDefaultUsersList());
}

populateListForUsers();

String username = "";
String device = "";

login(){
    Object userResult = fetchOne("select userid,fname,lname,email from user where userid='" + getListItemValue() + "';");
    User user = new User(userResult.get(0),userResult.get(1),userResult.get(2),userResult.get(3));
    userid = userResult.get(0);
    setUser(user);
    username = userResult.get(1) + " " + userResult.get(2);
    showTabGroup("control");
}

doNotDelete(){
    showToast("Delete Cancelled.");
}

onEvent("user/usertab/users", "click", "login()");